@if (isLoadingCycle()) {
  <div class="cycle-wizard">
    <div class="cycle-wizard__loading">
      <p-skeleton width="250px" height="1.75rem" />
      <p-skeleton width="100%" height="80px" styleClass="cycle-wizard__skeleton-steps" />
      <p-skeleton width="100%" height="300px" />
    </div>
  </div>
} @else if (loadError()) {
  <div class="cycle-wizard">
    <p-message severity="error" [text]="loadError()!" />
    <div class="cycle-wizard__error-actions">
      <p-button
        label="Volver al ciclo"
        icon="pi pi-arrow-left"
        [outlined]="true"
        (onClick)="goBack()"
      />
    </div>
  </div>
} @else if (cycle(); as c) {
  <div class="cycle-wizard">
    <!-- Header -->
    <div class="cycle-wizard__header">
      <div class="cycle-wizard__header-nav">
        <p-button
          label="Volver"
          icon="pi pi-arrow-left"
          [text]="true"
          (onClick)="goBack()"
          aria-label="Volver a detalle del ciclo"
        />
      </div>
      <div class="cycle-wizard__header-info">
        <h1 class="cycle-wizard__title">Configurar Ciclo</h1>
        <p class="cycle-wizard__subtitle">{{ c.name }} — {{ c.department }}</p>
      </div>
    </div>

    <!-- Stepper -->
    <p-stepper [value]="activeStep()" (valueChange)="goToStep($event ?? 1)" [linear]="true">
      <!-- Step 1: Locations -->
      <p-step-item [value]="1">
        <p-step>
          <ng-template #content let-activateCallback="activateCallback">
            <span class="cycle-wizard__step-label">
              <i class="pi pi-map-marker"></i>
              Ubicaciones
            </span>
          </ng-template>
        </p-step>
        <p-step-panel>
          <ng-template #content let-activateCallback="activateCallback">
            <div class="cycle-wizard__panel">
              <app-locations-step
                [initialRows]="locationRows()"
                (rowsChange)="onLocationsChange($event)"
              />
              <div class="cycle-wizard__panel-actions">
                <p-button
                  label="Siguiente"
                  icon="pi pi-arrow-right"
                  iconPos="right"
                  [disabled]="!canProceedFromLocations()"
                  (onClick)="nextFromLocations()"
                  aria-label="Continuar al paso de supervisores"
                />
              </div>
            </div>
          </ng-template>
        </p-step-panel>
      </p-step-item>

      <!-- Step 2: Supervisors -->
      <p-step-item [value]="2">
        <p-step>
          <ng-template #content let-activateCallback="activateCallback">
            <span class="cycle-wizard__step-label">
              <i class="pi pi-users"></i>
              Supervisores
            </span>
          </ng-template>
        </p-step>
        <p-step-panel>
          <ng-template #content let-activateCallback="activateCallback">
            <div class="cycle-wizard__panel">
              <app-supervisors-step
                [activeLocations]="activeLocations()"
                [initialAssignments]="supervisorAssignments()"
                (assignmentsChange)="onSupervisorsChange($event)"
              />
              <div class="cycle-wizard__panel-actions">
                <p-button
                  label="Anterior"
                  icon="pi pi-arrow-left"
                  [outlined]="true"
                  (onClick)="goToStep(1)"
                  aria-label="Volver al paso de ubicaciones"
                />
                <p-button
                  label="Siguiente"
                  icon="pi pi-arrow-right"
                  iconPos="right"
                  [disabled]="!canProceedFromSupervisors()"
                  (onClick)="nextFromSupervisors()"
                  aria-label="Continuar al paso de horarios"
                />
              </div>
            </div>
          </ng-template>
        </p-step-panel>
      </p-step-item>

      <!-- Step 3: Schedule -->
      <p-step-item [value]="3">
        <p-step>
          <ng-template #content let-activateCallback="activateCallback">
            <span class="cycle-wizard__step-label">
              <i class="pi pi-calendar"></i>
              Horarios
            </span>
          </ng-template>
        </p-step>
        <p-step-panel>
          <ng-template #content let-activateCallback="activateCallback">
            <div class="cycle-wizard__panel">
              <app-schedule-step
                [activeLocations]="activeLocations()"
                [initialSchedules]="scheduleMap()"
                (schedulesChange)="onSchedulesChange($event)"
              />

              @if (saveError()) {
                <p-message severity="error" [text]="saveError()!" />
              }

              <div class="cycle-wizard__panel-actions">
                <p-button
                  label="Anterior"
                  icon="pi pi-arrow-left"
                  [outlined]="true"
                  (onClick)="goToStep(2)"
                  aria-label="Volver al paso de supervisores"
                />
                <p-button
                  label="Guardar configuración"
                  icon="pi pi-check"
                  severity="success"
                  [disabled]="!canSave()"
                  [loading]="isSaving()"
                  (onClick)="save()"
                  aria-label="Guardar configuración del ciclo"
                />
              </div>
            </div>
          </ng-template>
        </p-step-panel>
      </p-step-item>
    </p-stepper>
  </div>
}
