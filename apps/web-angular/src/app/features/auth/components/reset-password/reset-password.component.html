<section class="reset-card animate-fade-in-up" aria-labelledby="reset-heading">

  @if (invalidToken()) {
    <!-- Invalid/expired token state -->
    <div class="reset-card__invalid animate-fade-in" role="alert">
      <div class="reset-card__invalid-icon" aria-hidden="true">
        <i class="pi pi-times-circle"></i>
      </div>
      <h1 class="reset-card__title" id="reset-heading">Enlace inválido</h1>
      <p class="reset-card__text">
        El enlace para restablecer tu contraseña ha expirado o es inválido.
        Por favor, solicita uno nuevo.
      </p>
      <a routerLink="/auth/forgot-password" class="reset-card__action-btn">
        Solicitar nuevo enlace
      </a>
      <a routerLink="/auth/login" class="reset-card__secondary-link">
        <i class="pi pi-arrow-left" aria-hidden="true"></i>
        Volver al inicio de sesión
      </a>
    </div>

  } @else if (success()) {
    <!-- Success state -->
    <div class="reset-card__success animate-fade-in" role="status" aria-live="polite">
      <div class="reset-card__success-icon" aria-hidden="true">
        <i class="pi pi-check-circle"></i>
      </div>
      <h1 class="reset-card__title" id="reset-heading">Contraseña restablecida</h1>
      <p class="reset-card__text">
        Tu contraseña ha sido cambiada exitosamente.
        Serás redirigido al inicio de sesión en unos segundos.
      </p>
      <a routerLink="/auth/login" class="reset-card__action-btn">
        <i class="pi pi-sign-in" aria-hidden="true"></i>
        Ir al inicio de sesión
      </a>
    </div>

  } @else {
    <!-- Reset form -->
    <header class="reset-card__header">
      <div class="reset-card__back-link-wrapper">
        <a routerLink="/auth/login" class="reset-card__back-link" aria-label="Volver al inicio de sesión">
          <i class="pi pi-arrow-left" aria-hidden="true"></i>
          Volver
        </a>
      </div>
      <div class="reset-card__icon" aria-hidden="true">
        <i class="pi pi-lock"></i>
      </div>
      <h1 class="reset-card__title" id="reset-heading">Nueva contraseña</h1>
      <p class="reset-card__subtitle">
        Crea una contraseña segura para tu cuenta.
      </p>
    </header>

    <form
      class="reset-card__form"
      [formGroup]="form"
      (ngSubmit)="onSubmit()"
      novalidate
      aria-label="Formulario de restablecimiento de contraseña"
    >
      <!-- New password field -->
      <div class="reset-card__field-group">
        <label for="new-password" class="reset-card__label">Nueva contraseña</label>
        <p-password
          inputId="new-password"
          formControlName="newPassword"
          [feedback]="false"
          [toggleMask]="true"
          placeholder="Mínimo 8 caracteres"
          styleClass="w-full"
          inputStyleClass="w-full"
          autocomplete="new-password"
          [class.p-invalid]="newPasswordControl.invalid && (newPasswordControl.dirty || newPasswordControl.touched)"
          aria-required="true"
          [attr.aria-invalid]="newPasswordControl.invalid && newPasswordControl.touched"
        />
        @if (newPasswordError) {
          <small class="reset-card__field-error" role="alert">
            <i class="pi pi-exclamation-circle" aria-hidden="true"></i>
            {{ newPasswordError }}
          </small>
        }
      </div>

      <!-- Password requirements -->
      @if (newPasswordControl.dirty || newPasswordControl.touched) {
        <ul class="reset-card__requirements" aria-label="Requisitos de contraseña">
          <li
            class="reset-card__req-item"
            [class.reset-card__req-item--valid]="requirements().isLongEnough"
          >
            <i
              class="pi"
              [class.pi-check-circle]="requirements().isLongEnough"
              [class.pi-circle]="!requirements().isLongEnough"
              aria-hidden="true"
            ></i>
            Al menos 8 caracteres
          </li>
          <li
            class="reset-card__req-item"
            [class.reset-card__req-item--valid]="requirements().hasUpperCase"
          >
            <i
              class="pi"
              [class.pi-check-circle]="requirements().hasUpperCase"
              [class.pi-circle]="!requirements().hasUpperCase"
              aria-hidden="true"
            ></i>
            Una letra mayúscula
          </li>
          <li
            class="reset-card__req-item"
            [class.reset-card__req-item--valid]="requirements().hasLowerCase"
          >
            <i
              class="pi"
              [class.pi-check-circle]="requirements().hasLowerCase"
              [class.pi-circle]="!requirements().hasLowerCase"
              aria-hidden="true"
            ></i>
            Una letra minúscula
          </li>
          <li
            class="reset-card__req-item"
            [class.reset-card__req-item--valid]="requirements().hasNumber"
          >
            <i
              class="pi"
              [class.pi-check-circle]="requirements().hasNumber"
              [class.pi-circle]="!requirements().hasNumber"
              aria-hidden="true"
            ></i>
            Un número
          </li>
        </ul>
      }

      <!-- Confirm password field -->
      <div class="reset-card__field-group">
        <label for="confirm-password" class="reset-card__label">Confirmar contraseña</label>
        <p-password
          inputId="confirm-password"
          formControlName="confirmPassword"
          [feedback]="false"
          [toggleMask]="true"
          placeholder="Repite tu contraseña"
          styleClass="w-full"
          inputStyleClass="w-full"
          autocomplete="new-password"
          [class.p-invalid]="confirmPasswordControl.invalid && (confirmPasswordControl.dirty || confirmPasswordControl.touched)"
          aria-required="true"
        />
        @if (confirmPasswordError) {
          <small class="reset-card__field-error" role="alert">
            <i class="pi pi-exclamation-circle" aria-hidden="true"></i>
            {{ confirmPasswordError }}
          </small>
        }
      </div>

      <button
        pButton
        type="submit"
        class="reset-card__submit-btn"
        [disabled]="isLoading()"
        [attr.aria-busy]="isLoading()"
      >
        @if (isLoading()) {
          <i class="pi pi-spin pi-spinner" aria-hidden="true"></i>
          Guardando...
        } @else {
          Restablecer contraseña
        }
      </button>
    </form>
  }

</section>
